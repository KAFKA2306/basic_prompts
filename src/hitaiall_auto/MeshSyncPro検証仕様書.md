## MeshSyncPro

### 1. 概要

**1.1. 目的**  
Unityエディタ上で3Dキャラクターの体メッシュと衣装メッシュ間の貫通を自動検出・高精度に修正し、自然な見た目を維持しつつ作業効率を大幅に改善するツール。

**1.2. 対象**  
ヒューマノイドリグを持つキャラクターを主対象とし、手足や顔などの重要部位は保護しつつ、広範囲の貫通問題に対応。

**1.3. 主な特徴**  
- 距離・法線ベクトルに加え、レイキャストを併用した面内包判定で微小貫通も検出。  
- Laplacianスムージングによる自然な頂点修正。  
- Undo/Redo対応で安全な編集。  
- ユーザーが調整可能なパラメータ群を用意。

---

### 2. システム構成

- **UI管理**: `EditorWindow`ベースで、アバター・メッシュ選択、パラメータ調整、検出・修正操作を提供。  
- **データ管理**: 選択アバターから`Animator`とメッシュレンダラーを取得し、保護頂点をキャッシュ。  
- **検出処理**: 体メッシュ頂点と衣装メッシュ頂点を比較し、距離・法線・レイキャスト判定で貫通頂点を抽出。  
- **修正処理**: 貫通頂点を衣装表面の最近接点方向に押し出し、スムージングで周辺を整形。  
- **表示処理**: Sceneビューに貫通頂点を可視化。  

---

### 3. UI設計

- **アバター選択**: GameObjectフィールド  
- **体メッシュ選択**: SkinnedMeshRendererリストから選択  
- **衣装メッシュ選択**: Rendererリストから選択  
- **パラメータ**:  
  - 貫通検出閾値（0.001～0.1、初期0.02）  
  - 基本オフセット（0.01～1、初期0.1）  
  - 影響範囲（隣接ステップ、0～10、初期5）  
  - スムージング反復回数（0～20、初期1）  
  - スムージング係数（0.0～1.0、初期0.5）  
- **保護ボーン管理**: 保護ボーンリスト表示と再計算ボタン  
- **操作ボタン**: 「貫通検出」「自動修正実行」  
- **検出結果表示**: 貫通頂点数とインデックスリスト  

---

### 4. コア機能詳細

#### 4.1. アバター・メッシュ読み込み

- アバターからAnimator取得  
- 子オブジェクトのSkinnedMeshRenderer・MeshRendererを列挙  
- ヒューマノイドリグ判定し、保護ボーンTransformをキャッシュ  
- 体メッシュ頂点の保護判定（BoneWeight参照）  

#### 4.2. 貫通検出

- 体・衣装メッシュをBakeMeshで現在形状取得（ワールド座標変換）  
- 保護頂点を除く体頂点ごとに衣装頂点との距離計算（総当たり）  
- 距離が閾値の倍程度以下で候補化  
- 法線と体→衣装頂点ベクトルの内積が負の閾値以下なら貫通と判定  
- レイキャストによる面内包判定を併用し微小貫通を検出  

#### 4.3. 貫通修正

- Undo登録を行いメッシュコピーを作成  
- 各貫通頂点について衣装メッシュ表面の最近接点と符号付き距離を計算  
- 貫通深度＋基本オフセット分だけ押し出し方向に頂点を移動（ローカル座標系で）  
- 押し出し後、隣接頂点も含めLaplacianスムージングを指定回数実施  
- 法線・バウンディングボックス再計算後、メッシュ差し替え  

#### 4.4. スムージング

- 隣接マップを三角形情報から構築  
- 貫通頂点を起点に隣接ステップ分の頂点を対象に設定（保護頂点除外）  
- 反復回数分、対象頂点を隣接頂点の平均位置にスムージング係数で補間  

---

### 5. データ構造

| 変数名                   | 型                        | 内容説明                                 |
|--------------------------|---------------------------|------------------------------------------|
| avatar                   | GameObject                | 選択されたアバターのルート               |
| bodyRenderer             | SkinnedMeshRenderer       | 体メッシュ                              |
| clothRenderer            | Renderer                  | 衣装メッシュ                            |
| protectedVertices        | HashSet              | 保護対象頂点インデックス                 |
| detectedPenetrationIndices | List                | 貫通検出頂点インデックス                 |
| detectedWorldPositions   | List             | 貫通頂点のワールド座標                   |
| vertices_local           | Vector3[]                 | 体メッシュのローカル頂点座標配列         |
| adjacencyMap             | Dictionary> | 頂点隣接マップ                          |

---

### 6. 今後の拡張案

- BVH/Octreeによる空間分割実装で大規模メッシュ対応  
- レイキャスト判定のさらなる精度向上  
- ユーザーによる保護ボーンカスタマイズ機能  
- パラメータプリセットの保存・読み込み  
